# name: Build, Push & Deploy Go App

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-push-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     # 1. Checkout repository
#     - name: Checkout Code
#       uses: actions/checkout@v4

#     # 2. Set up Go environment
#     - name: Set up Go
#       uses: actions/setup-go@v4
#       with:
#         go-version: 1.21

#     # 3. Login to Docker Hub
#     - name: Login to Docker Hub
#       uses: docker/login-action@v3
#       with:
#         username: ${{ secrets.DOCKER_USERNAME }}
#         password: ${{ secrets.DOCKER_PASSWORD }}

#     # 4. Build Docker image
#     - name: Build Docker Image
#       run: |
#         docker build -t ${{ secrets.DOCKER_USERNAME }}/google_trends:latest .

#     # 5. Push Docker image
#     - name: Push Docker Image
#       run: |
#         docker push ${{ secrets.DOCKER_USERNAME }}/google_trends:latest

#     # 6. Deploy on EC2
#     - name: Deploy on EC2
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#         host: ${{ secrets.EC2_HOST }}
#         username: ${{ secrets.EC2_USER }}
#         key: ${{ secrets.EC2_SSH_KEY }}
#         port: 22
#         timeout: 30s
#         command_timeout: 10m
#         script: |
#           echo "Pulling latest Docker image..."
#           docker pull ${{ secrets.DOCKER_USERNAME }}/google_trends:latest

#           echo "Stopping old container if exists..."
#           docker stop google_trends_app || true
#           docker rm google_trends_app || true

#           echo "Running new container..."
#           docker run -d \
#             --name google_trends_app \
#             -p 8080:8080 \
#             --restart unless-stopped \
#             ${{ secrets.DOCKER_USERNAME }}/google_trends:latest

#           echo "Cleaning up old unused images..."
#           docker image prune -f






name: Build, Push & Deploy Go App

on:
  push:
    branches:
      - dev
      - main

env:
  IMAGE_NAME: google_trends
  CONTAINER_NAME: google_trends_app

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repository
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Set up Go environment
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.21"
        cache: true

    # 3. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 4. Build Docker image (branch-based tag)
    - name: Build Docker Image
      run: |
        TAG=${GITHUB_REF##*/}
        docker build -t ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:$TAG .

    # 5. Push Docker image
    - name: Push Docker Image
      run: |
        TAG=${GITHUB_REF##*/}
        docker push ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:$TAG

    # ==========================
    # 6. Deploy to DEV EC2
    # ==========================
    - name: Deploy to DEV EC2
      if: github.ref == 'refs/heads/dev'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "Deploying DEV environment..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:dev
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8080:8080 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:dev
          docker image prune -f

    # ==========================
    # 7. Deploy to PROD EC2
    # ==========================
    - name: Deploy to PROD EC2
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PROD_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.PROD_EC2_SSH_KEY }}
        port: 22
        script: |
          echo "Deploying PROD environment..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:main
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8080:8080 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:main
          docker image prune -f
